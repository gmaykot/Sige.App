<div class="row"  *ngIf="!selected">
  <div class="col-md-12">
      <nb-card [nbSpinner]="loading" nbSpinnerStatus="info">
          <nb-card-header>Relatório de Economia</nb-card-header>
          <nb-card-body>
              <div class="row">
                  <div class="col-sm-2">
                      <div class="form-group">
                          <label for="inputEmail" class="label">Mês Referência</label><br />
                          <nb-select fullWidth placeholder="Selecione" (selectedChange)="onSearch($event)">
                              <nb-option>Selecione</nb-option>
                              <nb-option *ngFor="let mes of getMeses()"
                                  value="{{mes.id}}">{{mes.descricao}}</nb-option>
                          </nb-select>
                      </div>
                    </div>                   
              </div>
          </nb-card-body>
      </nb-card>
      <nb-card [nbSpinner]="loading" nbSpinnerStatus="info">
          <nb-card-header>Relatórios Emitidos</nb-card-header>
          <nb-card-body>
              <div class="row">
                  <div class="col-sm-12">
                      <ng2-smart-table [settings]="settings" [source]="source" (deleteConfirm)="onSelect($event)">
                      </ng2-smart-table>
                  </div>
              </div>
          </nb-card-body>
      </nb-card>        
  </div>
</div>

<form [formGroup]="control" *ngIf="selected">
    <div class="row">
        <div class="col-md-12">
            <nb-card accent="warning" [nbSpinner]="loading">
                <nb-card-header>Relatório de Economia {{relatorioEconomia.mesReferencia | date: 'MM/yyyy'}}</nb-card-header>
                <nb-card-body>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="subtitle sub-med">Unidade</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.unidade}}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="subtitle sub-med">Submercado</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.subMercado}}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="subtitle sub-med">Conexão</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.conexao}}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="subtitle sub-med">Concessão</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.concessao}}</div>
                        </div>
                    </div>
                    <div class="row top-up">
                        <div class="col-md-3">
                            <div class="subtitle sub-med">CNPJ</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.cnpj}}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="subtitle sub-med">Inscrição Estadual</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.inscricaoEstadual ?? '-'}}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="subtitle sub-med">Endereço</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.endereco}}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="subtitle sub-med">Munucípio</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.municipio}}</div>
                        </div>
                        <div class="col-md-1">
                            <div class="subtitle sub-med">UF</div>
                            <div class="h7">{{relatorioEconomia.cabecalho.uf}}</div>
                        </div>
                    </div>
                </nb-card-body>
            </nb-card>
        </div>
    </div>

    <div class="card-row" [nbSpinner]="loading">
        <div class="card-col">
            <nb-card accent="primary">
                <nb-card-body>
                    <nb-tabset>
                      <nb-tab tabTitle="Economia Mercado Livre vs. Mercado Cativo">
                        <nb-card style="border: 0rem;">
                            <nb-card-body>
                                <table class="fatura-tabela">
                                    <tr>
                                        <th colspan="3">Comparativo</th>
                                      </tr>
                                    <tr>
                                      <td>Diferença cativo versus livre</td>
                                      <td>Economia = 16%</td>
                                      <td>Total Economizado = R$ 16.403,12</td>
                                    </tr>
                                    <tr>
                                      <td>Valor devido a Coenel-DE</td>
                                      <td>2 Sal. Mín. + 10% economia</td>
                                      <td>Venc.: 16/01/2024 10%</td>
                                    </tr>
                                    <tr class="total-linha">
                                        <td><strong>Economia mensal líquida</strong></td>
                                        <td><strong>10,79%</strong></td>
                                        <td><strong>R$ 7.823,12</strong></td>
                                    </tr>                                        
                                    <tr class="total-linha">
                                        <td colspan="2"><strong>Economia acumulada</strong></td>
                                        <td><strong>R$ 1.262.582,18</strong></td>
                                    </tr>
                                </table>
                                <table class="fatura-tabela" style="margin-top: 1rem;">
                                    <tr class="total-linha">
                                        <th colspan="3"><strong>Observação: Todos os valores contemplam PIS/COFINS e ICMS</strong></th>
                                    </tr>
                                    <tr>
                                        <td>Valor devido a esta Coenel-DE</td>
                                        <td>R$ 2.640,00</td>
                                      </tr>                                        
                                </table>
                            </nb-card-body>
                        </nb-card>
                    </nb-tab>                      
                      <nb-tab *ngFor="let grupo of relatorioFinal?.grupos" tabTitle="{{grupo.titulo}}">
                        <nb-card style="border: 0rem;">
                            <nb-card-body>         
                                <table class="fatura-tabela">
                                    <tr>
                                      <th></th>
                                      <th style="text-align: center;">{{grupo.colunaQuantidade}}</th>
                                      <th style="text-align: center;">{{grupo.colunaValor}}</th>
                                      <th style="text-align: center;">{{grupo.colunaTotal}}</th>
                                    </tr>

                                    <ng-container *ngFor="let lanc of grupo?.subGrupos[0]?.lancamentos">
                                      <tr [ngClass]="lanc.totalizador == true ? 'total-linha' : lanc.subTotalizador == true ? 'sub-total-linha' : ''" *ngIf="(lanc.montante && lanc.montante !== 0) || (lanc.tarifa && lanc.tarifa !== 0) || (lanc.total && lanc.total !== 0)">
                                        <td style="text-align: left;">{{ lanc.descricao }}</td>
                                        <td style="text-align: center;">{{ lanc.montante | number:'1.2-2' }} {{getTipo(lanc.tipoMontante)}}</td>
                                        <td style="text-align: center;">{{ lanc.tarifa | number:'1.2-2' }} {{getTipo(lanc.tipoTarifa)}}</td>
                                        <td style="text-align: center;">{{ lanc.total | currency:'BRL':'symbol':'1.2-2' }}</td>
                                      </tr>
                                    </ng-container>                                   

                                    <tr class="total-linha">
                                      <td colspan="3"><strong>Total geral mercado cativo (impostos inclusos)</strong></td>
                                      <td style="text-align: center;"><strong>{{grupo.subGrupos[0]?.total?.total | currency:'BRL':'symbol':'1.2-2'}}</strong></td>
                                    </tr>
                                </table>
                            </nb-card-body>
                        </nb-card>
                      </nb-tab>
                    </nb-tabset>
                </nb-card-body>
                <nb-card-footer>
                    <button type="submit" nbButton status="basic" (click)="clear()">Voltar</button>
                    <button *ngIf="habilitaOperacoes" [disabled]="!control.valid || !habilitaPdf()" type="submit" nbButton status="info" style="margin-left: 0.5rem;" (click)="salvar()">Salvar</button>
                    <button *ngIf="habilitaOperacoes" [disabled]="!habilitaPdf()" type="submit" nbButton (click)="validar()" status="danger" style="margin-left: 0.5rem;">Validar</button>

                    <button [disabled]="!habilitaPdf()" type="submit" nbButton status="warning" style="margin-left: 0.5rem;" (click)="downloadAsPdf()">Gerar PDF</button>
                </nb-card-footer>                
            </nb-card>
        </div>
    </div>
</form>