using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Newtonsoft.Json;
using SIGE.Core.Options;
using System.Net.Http.Headers;
using System.Security.Authentication;
using System.Security.Cryptography.X509Certificates;

namespace SIGE.Services.HttpConfiguration.Ccee
{
    public static class CceeHttpClientConfig
    {
        public static IServiceCollection AddCCEEHttpClient(this IServiceCollection services, IConfiguration config)
        {
            services.Configure<CceeOptions>(o => config.GetSection("Services:Ccee").Bind(o));
            var cceeOptions = config.GetSection("Services:Ccee").Get<CceeOptions>();

            _ = services.AddHttpClient<IHttpClient<CceeHttpClient>, CceeHttpClient>()
                .ConfigurePrimaryHttpMessageHandler(services =>
                {
                    var handler = new HttpClientHandler()
                    {
                        ClientCertificateOptions = ClientCertificateOption.Manual,
                        SslProtocols = SslProtocols.Tls12 | SslProtocols.Tls13,
                        ServerCertificateCustomValidationCallback = (sender, certificate, chaim, errors) => true
                    };

                    X509Certificate2 certificate = null;

                    if (!string.IsNullOrEmpty(cceeOptions?.CertificateValue) && !cceeOptions.CertificateValue.Equals("${CERTIFICATE_VALUE}"))
                    {
                        Console.WriteLine("##SUCCESS: Certificate Injected");
                        Console.WriteLine("##SUCCESS: Certificate Options {0}", JsonConvert.SerializeObject(cceeOptions));
                        byte[] certBytes = Convert.FromBase64String(cceeOptions.CertificateValue);
                        certificate = new X509Certificate2("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", "Fodax@2024");

                        if (certificate != null)
                        {
                            Console.WriteLine("##SUCCESS: Certificate {0} - {1}", certificate.SerialNumber, certificate.FriendlyName);
                            handler.ClientCertificates.Add(certificate);
                        }                            
                    } else
                    {
                        Console.WriteLine("##ERRO: Certificate Value => {0}", cceeOptions?.CertificateValue);
                    }
                    return handler;
                })
                .SetHandlerLifetime(TimeSpan.FromMinutes(5))
                .ConfigureHttpClient((sp, client) =>
                {
                    client.Timeout = TimeSpan.FromMinutes(5);
                    client.BaseAddress = new Uri(cceeOptions.BaseUrl);

                    client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("text/xml"));
                });

            return services;
        }

        //Buscar certificados instalados na máquina local
        public static X509Certificate2? GetCurrentUserCertificates(string serialNumber)
        {
            var certificates = new List<X509Certificate2>();
            var store = new X509Store(StoreName.My, StoreLocation.CurrentUser);
            store.Open(OpenFlags.OpenExistingOnly);
            var cert = store.Certificates.FirstOrDefault(c => c.GetSerialNumberString().Equals(serialNumber));
            store.Close();
            return cert;
        }
    }
}
